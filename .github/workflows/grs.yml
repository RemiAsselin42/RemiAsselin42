name: Update README cards

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      DOB: "2005-01-12"
    steps:
      - uses: actions/checkout@v4

      - name: Generate top languages card
        uses: readme-tools/github-readme-stats-action@v1
        with:
          card: top-langs
          options: username=${{ github.repository_owner }}&layout=compact
          path: profile/top-langs.svg
          token: ${{ secrets.GH_PV_REPO_TOKEN }}

      - name: Update README age
        run: |
          current_year=$(date -u +%Y)
          birth_year=$(date -u -d "$DOB" +%Y)
          age=$((current_year - birth_year))
          if [ "$(date -u +%m%d)" -lt "$(date -u -d "$DOB" +%m%d)" ]; then
            age=$((age - 1))
          fi
          sed -i "s/I'm a [0-9]\+yo/I'm a ${age}yo/" README.md

      - name: Update README cache buster
        run: |
          ts=$(date +%s)
          sed -i "s|top-langs.svg?v=[0-9]*|top-langs.svg?v=$ts|g" README.md

      - name: Commit cards
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add profile/*.svg README.md
          git commit -m "Update README cards" || exit 0
          git push
